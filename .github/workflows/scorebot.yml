name: Score Auto-Sync

on:
  # Manual button in the Actions tab
  workflow_dispatch:
    inputs:
      week:
        description: "Run a single week (leave empty for all)"
        required: false
  # Scheduled runs (UTC times)
  schedule:
    # Sunday Night (after SNF) ~ 11:30pm ET ≈ 04:30 UTC Monday
    - cron: '30 4 * * 1'
    # After Monday Night Football ~ 12:30–1:30am PT ≈ 05:30 UTC Tuesday
    - cron: '30 5 * * 2'
    # Tuesday morning backstop ~ 9:00am ET ≈ 13:00 UTC Tuesday
    - cron: '0 13 * * 2'

jobs:
  run-score-sync:
    runs-on: ubuntu-latest
    env:
      RW_DB: ${{ secrets.RW_DB }}
      RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
      ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
      NODE_TLS_REJECT_UNAUTHORIZED: 0

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install deps
        run: npm ci || npm i --no-audit --no-fund

      - name: Run sync (all or single week)
        run: |
          if [ -n "${{ inputs.week }}" ]; then
            echo "Running single week ${{ inputs.week }}"
            node scripts/fetchScores.js --week ${{ inputs.week }} --fix
          else
            echo "Running all started weeks"
            node scripts/fetchScores.js --all --fix
          fi
