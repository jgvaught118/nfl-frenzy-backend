name: Score Auto-Sync

on:
  schedule:
    # Mon 04:30 UTC (post-SNF), Tue 05:30 UTC (post-MNF), Tue 13:00 UTC backstop
    - cron: "30 4 * * 1"
    - cron: "30 5 * * 2"
    - cron: "0 13 * * 2"
  workflow_dispatch:
    inputs:
      week:
        description: "Specific week to process (leave blank for all started weeks)"
        required: false
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RW_DB: ${{ secrets.RW_DB }}
      RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
      ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
      # ESPN uses HTTPS; your Railway cert setup has been fussy, so keep this off:
      NODE_TLS_REJECT_UNAUTHORIZED: "0"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Verify secrets are present
        run: |
          [ -n "$RW_DB" ] || { echo "❌ RW_DB is missing"; exit 1; }
          [ -n "$RAILWAY_URL" ] || { echo "❌ RAILWAY_URL is missing"; exit 1; }
          [ -n "$ADMIN_KEY" ] || { echo "❌ ADMIN_KEY is missing"; exit 1; }
          echo "✅ Secrets present"

      - name: Run score sync
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK=${{ github.event.inputs.week }} npm run scores:week
          else
            npm run scores:now
          fi
